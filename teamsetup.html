<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Final Evolution: Digi - Team Setup</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{ 
      --bg:#0b1020; --panel:#101735; --panel-2:#0d1330; --text:#e9ecf7; --muted:#9aa3c4; 
      --brand:#59a6ff; --accent:#ffd166; --chip:#1e2a54; --ring:#1b2547; --ok:#31d0aa; --warn:#ff7a7a; 
      --shadow: 0 10px 30px rgba(0,0,0,.35); 
      --shadow-sm: 0 4px 12px rgba(0,0,0,.25); 
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    } 
    *{box-sizing:border-box} 
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Roboto,Inter,Arial} 
    a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline} 
    /* NAVBAR */ 
    .nav{position:sticky; top:0; z-index:50; background:linear-gradient(180deg,#0b1020,rgba(11,16,32,.72)); border-bottom:1px solid var(--ring); backdrop-filter: blur(10px);} 
    .nav-inner{max-width:1200px;margin:auto;padding:12px 18px;display:flex;align-items:center;gap:16px; position:relative} 
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px} 
    .brand .logo{width:28px;height:28px;border-radius:7px;background: radial-gradient(120% 120% at 20% 20%, #5ac8ff 0%, #2441ff 38%, #0b1020 80%); box-shadow: 0 0 0 1px #2b3772 inset, 0 4px 16px rgba(36,65,255,.35);} 
    .spacer{flex:1}
    .nav a.navlink{color:var(--text);opacity:.9;transition:var(--transition);padding:8px 12px;border-radius:8px;text-decoration:none} 
    .nav a.navlink:hover{opacity:1;color:#cfe0ff;background:rgba(42,61,134,.2)} 
    .nav a.navlink.active{background:rgba(42,61,134,.3);color:#59a6ff} 
    /* Burger additions */
    .nav-toggle{display:none;border:1px solid var(--ring);background:var(--panel);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
    .nav-menu{display:flex;align-items:center;gap:8px;list-style:none;margin:0;padding:0}
    .nav-menu li{display:inline-flex}

    /* HERO */ 
    .hero{max-width:1200px;margin:20px auto 8px;padding:0 18px;text-align:center} 
    .hero h1{margin:6px 0 6px;font-size:clamp(28px,5vw,48px);background:linear-gradient(90deg,#59a6ff,#ffd166);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800} 
    .hero p{margin:0;color:var(--muted);font-size:18px} 
    /* PANELS */ 
    .panel{max-width:1200px;margin:14px auto;padding:14px 18px} 
    .panel-box{ background:var(--panel); border:1px solid var(--ring); border-radius:16px; box-shadow:var(--shadow); padding:20px; transition:var(--transition);} 
    .panel-box:hover{ transform:translateY(-4px); box-shadow:0 15px 40px rgba(0,0,0,.4); border-color:#2a3d86; } 
    /* CHIPS */ 
    .chip{ background:var(--chip); color:#b9c6ff; padding:6px 12px; border-radius:8px; font-size:13px; font-weight:600; transition:var(--transition); display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(255,255,255,.1); text-decoration:none !important; cursor:default;} 
    .chip.click{ cursor:pointer; } 
    .chip:hover{ background:linear-gradient(135deg,#2a3d86,#243570); transform:translateY(-1px); box-shadow:0 2px 8px rgba(42,61,134,.4); border-color:rgba(255,255,255,.2) } 
    /* GRID LAYOUT */ 
    .wrap{max-width:1200px;margin:0 auto 30px;padding:0 18px; display:grid; grid-template-columns: 1.4fr .8fr; gap:20px} 
    @media (max-width:1000px){ .wrap{ grid-template-columns: 1fr; } } 
    /* TEAM SLOTS */ 
    .team{display:grid; gap:16px} 
    .row{display:grid; gap:16px} 
    .row.top{ grid-template-columns: repeat(2, 1fr); } 
    .row.bottom{ grid-template-columns: repeat(3, 1fr); } 
    @media (max-width:680px){ .row.top{grid-template-columns: 1fr} .row.bottom{grid-template-columns: 1fr} } 
    .slot{ background:var(--panel-2); border:1px solid var(--ring); border-radius:14px; overflow:hidden; min-height:170px; display:flex; flex-direction:column; justify-content:space-between; box-shadow:var(--shadow-sm); transition:var(--transition);} 
    .slot:hover{ transform:translateY(-3px); border-color:#2a3d86 } 
    .slot .thumb{ aspect-ratio:1/1; background:#0b132b; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer;} 
    .slot .thumb .placeholder{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#8ea3ff; font-weight:800; font-size:42px; user-select:none;} 
    /* ===== PATCH: TAMPILKAN GAMBAR SPRITE SAAT DIPILIH + FALLBACK ===== */
    .slot .thumb img.digimon-sprite{ max-width:100%; max-height:100%; display:block; margin:auto; object-fit:contain; }
    /* ======================================================= */
    .slot .namebar{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-top:1px solid var(--ring)} 
    .slot .name{color:#cfe0ff; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis} 
    .slot .actions{display:flex; gap:8px} 
    .btn{ background:var(--panel); border:1px solid var(--ring); color:#cfe0ff; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; } 
    .btn:hover{ border-color:#2a3d86; background:#13214e } 
    .mini{padding:8px 12px; border-top:1px solid var(--ring); display:flex; flex-direction:column; gap:8px} 
    .mf-row{display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center} 
    .mf-row .chip{justify-content:center} 
    .traits-row{display:flex; flex-wrap:wrap; gap:6px} 
    /* SIDEBAR INFO */ 
    .kv{ display:grid; grid-template-columns:140px 1fr; gap:8px 12px; } 
    .kv b{ color:#cfe0ff; font-weight:600; font-size:15px; } 
    .meta{ display:flex; flex-wrap:wrap; gap:8px } 
    .subtitle{margin:0 0 10px; color:#cfe0ff; font-size:16px} 
    /* MODAL SEARCH */ 
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000 } 
    .modal{ width:min(980px, 96vw); background:var(--panel); border:1px solid var(--ring); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; 
            display:grid; grid-template-rows:auto 1fr; max-height:92vh; } 
    .modal .hd{ padding:12px 16px; border-bottom:1px solid var(--ring); display:grid; grid-template-columns: 1fr; gap:10px; position:sticky; top:0; z-index:2; background:var(--panel)} 
    .modal .hd .topbar{ display:flex; gap:10px; align-items:center } 
    .modal .hd input, .modal select{ width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--ring); background:var(--panel-2); color:var(--text); font-size:15px; } 
    .filter-row{ display:grid; grid-template-columns: repeat(4, minmax(140px,1fr)); gap:10px } 
    .modal .bd{ max-height:60vh; overflow:auto; padding:16px } 
    .names{ display:flex; flex-wrap:wrap; gap:10px } 
    .name-pill{ display:inline-flex; padding:8px 14px; border-radius:999px; background:linear-gradient(135deg, #0c1530, #0a1228); border:1px solid var(--ring); color:#b9c6ff; text-decoration:none; font-size:14px; transition:var(--transition); font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.2); } 
    .name-pill:hover{ border-color:#2a3d86; background:linear-gradient(135deg,#121d40,#0e1835); transform:translateY(-2px); color:#59a6ff } 
    .name-pill.disabled{ opacity:.45; cursor:not-allowed; pointer-events:none; } 
    .empty{color:var(--muted); padding:10px 0} 
    /* FOOTER */ 
    footer{border-top:1px solid var(--ring);color:var(--muted);text-align:center;padding:20px 18px;margin-top:20px} 
    .footer-links{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:12px 18px;margin:12px 0 8px}
    .footer-links a{color:var(--muted);text-decoration:none;transition:var(--transition);padding:8px 14px;border-radius:8px}
    .footer-links a:hover{color:var(--brand);background:rgba(42,61,134,.2)}
    .disclaimer{font-size:12px;color:#8e96b5}
    /* Responsive burger & modal filters */
    @media (max-width:768px){
      .nav-toggle{display:inline-flex;align-items:center;justify-content:center}
      .nav-menu{display:none;position:absolute;left:0;right:0;top:100%;margin:0;padding:8px 12px 12px;background:rgba(11,16,32,.96);backdrop-filter:blur(10px);border-bottom:1px solid var(--ring);box-shadow:0 10px 20px rgba(0,0,0,.45);flex-direction:column;align-items:stretch;gap:6px;max-height:70vh;overflow:auto}
      .nav-menu.open{display:flex}
      .nav-menu li{display:block}
      .nav a.navlink{display:block;padding:12px 12px}
      .filter-row{grid-template-columns:1fr;gap:8px}
      .modal{max-height:88vh}
      .modal .hd input, .modal select{min-height:44px;font-size:16px}
    }
  
/* ===== Patch: kontrol lebar substitusi & wrapping (minimal-change) ===== */
#recSubsBox{display:flex;flex-wrap:wrap;gap:8px;max-width:100%;overflow-wrap:break-word;}
#recSubsBox .chip{flex-shrink:0;}

</style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <span>Final Evolution: Digi<span style="color:#cfe0ff"> - Team Setup</span></span>
      </div>
      <div class="spacer"></div>
      <button class="nav-toggle" id="navToggle" aria-expanded="false" aria-controls="menu" aria-label="Buka menu">‚ò∞</button>
      <ul class="nav-menu" id="menu" aria-expanded="false">
        <li><a class="navlink" href="./index.html">Home</a></li>
        <li><a class="navlink" href="./digimon.html">Digi‚ÄëDex</a></li>
        <li><a class="navlink" href="./items.html">Items</a></li>
        <li><a class="navlink" href="./tamers.html">Tamers</a></li>
        <li><a class="navlink" href="./about.html">About</a></li>
      </ul>
    </div>
  </nav>
  <!-- HERO -->
  <header class="hero">
    <h1>Final Evolution: Digi - Team Setup</h1>
    <p>Ingin coba susun sendiri komposisi 5 Digimon dan lihat bonus Type/Race & rekomendasi tamer otomatis? Atau silahkan pilih tim yang sudah direkomendasikan!</p>
  </header>
  <section class="wrap">
    <div class="panel-box">
      <h3 style="margin:0 0 12px; color:#cfe0ff; font-size:20px">üß© Susun Tim 5 Digimon</h3>
      <div class="team">
        <div class="row top">
          <div class="slot" data-index="0">
            <div class="thumb" title="Klik untuk memilih Digimon"><div class="placeholder">?</div></div>
            <div class="namebar">
              <div class="name">Digimon Name</div>
              <div class="actions">
                <button class="btn js-pick">Pilih</button>
                <button class="btn js-clear">Clear</button>
              </div>
            </div>
            <div class="mini">
              <div class="mf-row">
                <span class="chip" data-type>‚Äî</span>
                <span class="chip" data-faction>‚Äî</span>
              </div>
              <div class="traits-row" data-traits></div>
            </div>
          </div>
          <div class="slot" data-index="1">
            <div class="thumb" title="Klik untuk memilih Digimon"><div class="placeholder">?</div></div>
            <div class="namebar">
              <div class="name">Digimon Name</div>
              <div class="actions">
                <button class="btn js-pick">Pilih</button>
                <button class="btn js-clear">Clear</button>
              </div>
            </div>
            <div class="mini">
              <div class="mf-row">
                <span class="chip" data-type>‚Äî</span>
                <span class="chip" data-faction>‚Äî</span>
              </div>
              <div class="traits-row" data-traits></div>
            </div>
          </div>
        </div>
        <div class="row bottom">
          <div class="slot" data-index="2">
            <div class="thumb" title="Klik untuk memilih Digimon"><div class="placeholder">?</div></div>
            <div class="namebar">
              <div class="name">Digimon Name</div>
              <div class="actions">
                <button class="btn js-pick">Pilih</button>
                <button class="btn js-clear">Clear</button>
              </div>
            </div>
            <div class="mini">
              <div class="mf-row">
                <span class="chip" data-type>‚Äî</span>
                <span class="chip" data-faction>‚Äî</span>
              </div>
              <div class="traits-row" data-traits></div>
            </div>
          </div>
          <div class="slot" data-index="3">
            <div class="thumb" title="Klik untuk memilih Digimon"><div class="placeholder">?</div></div>
            <div class="namebar">
              <div class="name">Digimon Name</div>
              <div class="actions">
                <button class="btn js-pick">Pilih</button>
                <button class="btn js-clear">Clear</button>
              </div>
            </div>
            <div class="mini">
              <div class="mf-row">
                <span class="chip" data-type>‚Äî</span>
                <span class="chip" data-faction>‚Äî</span>
              </div>
              <div class="traits-row" data-traits></div>
            </div>
          </div>
          <div class="slot" data-index="4">
            <div class="thumb" title="Klik untuk memilih Digimon"><div class="placeholder">?</div></div>
            <div class="namebar">
              <div class="name">Digimon Name</div>
              <div class="actions">
                <button class="btn js-pick">Pilih</button>
                <button class="btn js-clear">Clear</button>
              </div>
            </div>
            <div class="mini">
              <div class="mf-row">
                <span class="chip" data-type>‚Äî</span>
                <span class="chip" data-faction>‚Äî</span>
              </div>
              <div class="traits-row" data-traits></div>
            </div>
          </div>
        </div>
      </div>
      <p class="empty" id="hintEmpty" style="margin-top:12px">Klik tombol <b>Pilih</b> atau <b>tanda tanya</b> di kotak slot untuk memilih Digimon.</p>
    </div>
    <aside class="panel-box">
      <h3 style="margin:0 0 12px; color:#cfe0ff; font-size:20px">üìä Ringkasan Tim</h3>
      <div class="kv" style="margin-bottom:12px">
        <b>Type / Race Bonus</b>
        <span id="raceBonus">ATK +0%, MAX HP +0%</span>
        <b>Recommended Tamer</b>
        <span id="recTamer">‚Äî</span>
        <b>Faction Summary</b>
        <span id="factionSummary">‚Äî</span>
        <b>Type Summary</b>
        <span id="typeSummary">‚Äî</span>
        <b>Traits Counter</b>
        <span id="traitsSummary">‚Äî</span>
      </div>
      <div class="meta" id="teamListChips"></div>
<hr style="border-color:var(--ring);opacity:.6;margin:16px 0">

<h3 style="margin:0 0 12px; color:#cfe0ff; font-size:20px">üî• Rekomendasi Tim</h3>
<div id="recTeamList" style="display:flex;flex-wrap:wrap;gap:8px 10px"></div>
<div id="recSubsBox" style="margin-top:12px;color:#cfe0ff"></div>
<div id="recTamerNote" style="margin-top:8px;color:#9aa3c4;font-size:13px" hidden>(Tamer dikunci sesuai rekomendasi)</div>
<button class="btn" id="btnUnlockTamer" style="margin-top:10px" hidden>Lepas Kunci Tamer</button>

    </aside>
  </section>
  <!-- MODAL PICKER -->
  <div class="overlay" id="picker" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pickTitle">
      <div class="hd">
        <div class="topbar">
          <div class="chip">üîé Pilih Digimon</div>
          <button class="btn" id="btnClose">Tutup</button>
        </div>
        <input id="pickSearch" type="text" placeholder="Ketik nama atau alias‚Ä¶ (Agumon, Beelko, Monarch X, dll.)" />
        <div class="filter-row">
          <select id="filterStage" aria-label="Filter Stage">
            <option value="">Semua Stage</option>
          </select>
          <select id="filterFaction" aria-label="Filter Faction">
            <option value="">Semua Faction</option>
          </select>
          <select id="filterType" aria-label="Filter Type">
            <option value="">Semua Type</option>
          </select>
          <select id="filterTrait" aria-label="Filter Traits">
            <option value="">Semua Traits</option>
          </select>
        </div>
      </div>
      <div class="bd">
        <div id="pickResults" class="names"></div>
        <p id="pickEmpty" class="empty" hidden>Tidak ada hasil.</p>
      </div>
    </div>
  </div>
  <footer>
    <div style="font-size:18px;font-weight:700">Final Evolution: Digi</div>
    <div class="footer-links">
      <a href="./index.html">Home</a>
      <a href="./digimon.html">Digi‚ÄëDex</a>
      <a href="./items.html">Items</a>
      <a href="./tamers.html">Tamers</a>
      <a href="./about.html">About</a>
    </div>
    <div class="disclaimer" style="margin-top:6px">
      Digimon and all related characters are trademarks of Bandai Namco Holdings Inc.<br/>
      This is a non‚Äëcommercial fan project created by the Digimon World Indonesia community.<br/>
      ¬© 2026 Final Evolution: Digi ‚Ä¢ On Progress by Joe ‚Ä¢ Supported by Digimon World Indonesia 
    </div>
  </footer>
  <script>
    /* Burger nav */
    const toggleBtn = document.getElementById('navToggle');
    const menu = document.getElementById('menu');
    function closeMenu(){ menu?.classList.remove('open'); toggleBtn?.setAttribute('aria-expanded','false'); }
    function openMenu(){ menu?.classList.add('open'); toggleBtn?.setAttribute('aria-expanded','true'); }
    toggleBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.contains('open') ? closeMenu() : openMenu(); });
    document.addEventListener('pointerdown', (e)=>{ if(menu?.classList.contains('open')){ if(!menu.contains(e.target) && !toggleBtn.contains(e.target)) closeMenu(); }});
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    const mqDesktop = window.matchMedia('(min-width: 769px)'); mqDesktop.addEventListener('change', ev=>{ if(ev.matches) closeMenu(); });
    /* ====== SOURCES ====== */ 
    const JSON_DIGI = 'data/digimon_evolution_lines.json'; // id, displayName, stage, factions, types, aliases, traits 
    const JSON_TAMERS = 'data/tamers.json'; // name, skillName, givingBuffFor 
    const JSON_REF = 'data/digimon_reference.json'; // factions (code,color,icon), types (name,icon), traits (id,name,icon,...) 
    /* ====== STATE ====== */ 
    let DB = []; let TAMERS = []; let REF = null; const TEAM = [null, null, null, null, null]; let activeIndex = 0;
 let LOCKED_TAMER = null; 
    const $ = (sel, root=document) => root.querySelector(sel); const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel)); 
    const norm = s => (s ?? '').toLowerCase().trim(); const byId = id => DB.find(x => norm(x.id) === norm(id)); 
    const factionIconName = code => { const f = REF?.factions?.find(x => x.code && x.code.trim() === (code ?? '').trim()); return f ? `${(f.icon ?? '')} ${(f.name ?? code)}`.trim() : (code ?? '-'); }; 
    const typeIconName = name => { const t = REF?.types?.find(x => x.name && x.name.trim() === (name ?? '').trim()); return t ? `${(t.icon ?? '')} ${(t.name ?? name)}`.trim() : (name ?? '-'); }; 
    function allStages(){ const ord = ['Child','Adult','Perfect','Ultimate','Ultimate+']; const s = Array.from(new Set(DB.map(d => (d.stage ?? '').trim()))).filter(Boolean); return s.sort((a,b)=> ord.indexOf(a)-ord.indexOf(b)); } 
    function allFactions(){ const set = new Set(); DB.forEach(d => (d.factions ?? []).forEach(f => set.add((f ?? '').trim()))); return Array.from(set).filter(Boolean).sort(); } 
    function allTypes(){ const set = new Set(); DB.forEach(d => (d.types ?? []).forEach(t => set.add((t ?? '').trim()))); return Array.from(set).filter(Boolean).sort(); } 
    function allTraits(){ const set = new Set(); DB.forEach(d => (d.traits ?? []).forEach(t => set.add((t ?? '').trim()))); const order = REF?.traits?.map(t => t.id) ?? []; return Array.from(set).sort((a,b) => order.indexOf(a) - order.indexOf(b)); } 
    function fillFilters(){ const stSel = $('#filterStage'), faSel = $('#filterFaction'), tySel = $('#filterType'), trSel = $('#filterTrait'); allStages().forEach(s => stSel.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`)); allFactions().forEach(c => faSel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`)); allTypes().forEach(t => tySel.insertAdjacentHTML('beforeend', `<option value="${t}">${t}</option>`)); allTraits().forEach(tid => { const tr = REF?.traits?.find(x => x.id === tid); const label = tr ? `${tr.icon} ${tr.name}` : tid; trSel.insertAdjacentHTML('beforeend', `<option value="${tid}">${label}</option>`); }); } 
    function namePill(d){ const taken = TEAM.includes(d.id); if (taken) return `<span class="name-pill disabled" title="Sudah dipilih di tim">${d.displayName}</span>`; return `<a href="#" class="name-pill" data-pick="${d.id}">${d.displayName}</a>`; } 
    function openPicker(index){ activeIndex = index; $('#picker').style.display = 'flex'; $('#picker').setAttribute('aria-hidden','false'); $('#pickSearch').value=''; renderPickResults(); setTimeout(()=> $('#pickSearch').focus(), 30); } 
    function closePicker(){ $('#picker').style.display = 'none'; $('#picker').setAttribute('aria-hidden','true'); } 
    function getFilterValues(){ return { q: norm($('#pickSearch').value), stage: $('#filterStage').value, faction: $('#filterFaction').value, type: $('#filterType').value, trait: $('#filterTrait').value }; } 
    function renderPickResults(){ const { q, stage, faction, type, trait } = getFilterValues(); let arr = DB.slice(); if (stage) arr = arr.filter(d => (d.stage ?? '').trim() === stage); if (faction) arr = arr.filter(d => (d.factions ?? []).some(f => (f ?? '').trim() === faction)); if (type) arr = arr.filter(d => (d.types ?? []).some(t => (t ?? '').trim() === type)); if (trait) arr = arr.filter(d => (d.traits ?? []).some(t => (t ?? '').trim() === trait)); if (q){ arr = arr.filter(d => norm(d.displayName).includes(q) || (d.aliases ?? []).some(a => norm(a).includes(q))); } arr.sort((a,b)=> a.displayName.localeCompare(b.displayName)); $('#pickResults').innerHTML = arr.map(namePill).join(''); $('#pickEmpty').hidden = arr.length > 0; } 
    const typeAbbr = (t) => t==='Data' ? 'DA' : t==='Vaccine' ? 'VA' : t==='Virus' ? 'VI' : '?'; 
    const typeColor = (t) => ({ Data:'#ffffff', Vaccine:'#59a6ff', Virus:'#ff7a7a' }[t] ?? '#b9c6ff'); 
    function renderSlotMeta(slot, d){ const typeEl = $('[data-type]', slot); const facEl = $('[data-faction]', slot); const traitsEl = $('[data-traits]', slot); if (!d){ typeEl.textContent='‚Äî'; typeEl.removeAttribute('style'); facEl.textContent='‚Äî'; facEl.removeAttribute('style'); traitsEl.innerHTML=''; return; } const type = (d.types ?? [])[0]?.trim(); if (type){ const col = typeColor(type); typeEl.innerHTML = `${typeAbbr(type)}`; typeEl.setAttribute('title', type); typeEl.style.background = `${col}22`; typeEl.style.border = `1px solid ${col}55`; typeEl.style.color = col; typeEl.classList.add('chip'); } else { typeEl.textContent='‚Äî'; typeEl.removeAttribute('style'); } const fac = (d.factions ?? [])[0]?.trim(); if (fac){ const fmeta = REF?.factions?.find(x => x.code.trim() === fac); const col = (fmeta?.color ?? '#b9c6ff').trim(); facEl.innerHTML = `${fac}`; facEl.setAttribute('title', factionIconName(fac)); facEl.style.background = `${col}22`; facEl.style.border = `1px solid ${col}55`; facEl.style.color = col; facEl.classList.add('chip'); } else { facEl.textContent='‚Äî'; facEl.removeAttribute('style'); } const ticons = (d.traits ?? []).map(tid => { const tr = REF?.traits?.find(x => x.id.trim() === tid); if (tr) return `<span class="chip" title="${tr.name}">${tr.icon}</span>`; return `<span class="chip">${tid}</span>`; }).join(' '); traitsEl.innerHTML = ticons || ''; } 
    function renderTeamBoard(){ 
      $$('.slot').forEach(slot => { 
        const idx = Number(slot.dataset.index); 
        const id = TEAM[idx]; 
        const nameEl = $('.name', slot); 
        const thumb = $('.thumb', slot); 
        if (!id){ 
          nameEl.textContent = 'Digimon Name'; 
          thumb.innerHTML = '<div class="placeholder">?</div>'; 
          renderSlotMeta(slot, null); 
          return; 
        } 
        const d = byId(id); 
        nameEl.textContent = d?.displayName ?? id; 
        // TAMPILKAN GAMBAR SPRITE + FALLBACK KE UNKNOWN JIKA GAGAL LOAD
        if (d) {
          thumb.innerHTML = `<img src="./images/sprites/sprite_${id}.png" alt="${d.displayName}" class="digimon-sprite" onerror="this.onerror=null;this.src='./images/sprites/sprites_unknown.png'">`;
        } else {
          thumb.innerHTML = '<div class="placeholder">?</div>';
        }
        renderSlotMeta(slot, d); 
      }); 
      const chipBox = $('#teamListChips'); 
      const chips = TEAM.map(id => id ? byId(id) : null).filter(Boolean).map(d => `<a class="chip click" href="./digimon.html#${encodeURIComponent(d.id)}" title="Buka di Digi‚ÄëDex">${d.displayName}</a>`); 
      chipBox.innerHTML = chips.length ? chips.join(' ') : '<span class="chip">Belum ada anggota</span>'; 
      recalcSummaries(); 
    } 
    function raceBonus(teamDigis){ const types = teamDigis.map(d => (d.types ?? [])[0]).filter(Boolean); const counts = {}; types.forEach(t => counts[t] = (counts[t] ?? 0)+1); const vals = Object.values(counts).sort((a,b)=>b-a); let atk=0, hp=0; if (vals[0] === 5){ atk=25; hp=25; } else if (vals[0] === 4){ atk=15; hp=15; } else if (vals[0] === 3){ if (vals[1] === 2) { atk=15; hp=15; } else { atk=10; hp=10; } } return { atk, hp, typeCounts: counts }; } 
    function mapTamersByFaction(){ const m = {}; (TAMERS ?? []).forEach(t => { const code = (t.givingBuffFor ?? '').trim(); if (!code) return; (m[code] = m[code] ?? []).push(t); }); return m; } 
    function recommendTamers(teamDigis){ const facCounts = {}; teamDigis.forEach(d => { const code = (d.factions ?? [])[0]; if (!code) return; facCounts[code] = (facCounts[code] ?? 0)+1; }); const entries = Object.entries(facCounts).sort((a,b)=> b[1]-a[1]); if (!entries.length) return { text: '‚Äî', summary: '‚Äî' }; const facChips = entries.map(([code,c]) => `<span class="chip">${factionIconName(code)} √ó ${c}</span>`).join(' '); const max = entries[0][1]; const out = []; if (max >= 3){ entries.forEach(([code,c]) => { if (c >= 3) out.push(code); }); const two = entries.find(([,c]) => c === 2); if (two) out.push(two[0]); } else if (max === 2){ entries.forEach(([code,c]) => { if (c === 2) out.push(code); }); } else { return { text: 'SILAHKAN SESUAIKAN KEMBALI', summary: facChips }; } const tMap = mapTamersByFaction(); const names = out.map(code => { const list = tMap[code] ?? []; if (!list.length) return factionIconName(code); return list.map(t => t.name).join(' & '); }); return { text: names.join(' & '), summary: facChips }; } 
    function recalcSummaries(){ const teamDigis = TEAM.map(id => id ? byId(id) : null).filter(Boolean); const { typeCounts } = raceBonus(teamDigis); const typeChips = Object.entries(typeCounts).sort((a,b)=> b[1]-a[1]).map(([t,c]) => `<span class="chip">${typeIconName(t)} √ó ${c}</span>`).join(' '); $('#typeSummary').innerHTML = typeChips || '‚Äî'; const rb = raceBonus(teamDigis); $('#raceBonus').textContent = `ATK +${rb.atk}%, MAX HP +${rb.hp}%`; if (LOCKED_TAMER) { const t = (TAMERS || []).find(x => x.id === LOCKED_TAMER); $('#recTamer').textContent = t?.name || LOCKED_TAMER; } else { const rt = recommendTamers(teamDigis); $('#recTamer').textContent = rt.text || '‚Äî'; $('#factionSummary').innerHTML = rt.summary || '‚Äî'; } const tCount = {}; teamDigis.forEach(d => (d.traits ?? []).forEach(t => tCount[t] = (tCount[t] ?? 0)+1)); const tChips = Object.entries(tCount).sort((a,b)=> b[1]-a[1]).map(([tid,c]) => { const tr = REF?.traits?.find(x => x.id.trim() === tid); return `<span class="chip" title="${tr?.description ?? ''}">${tr?.icon ?? '‚Ä¢'} ${tr?.name ?? tid} √ó ${c}</span>`; }).join(' '); $('#traitsSummary').innerHTML = tChips || '‚Äî'; } 
    (async function init(){ try{ const [resD, resT, resR] = await Promise.all([ fetch(JSON_DIGI, {cache:'no-store'}), fetch(JSON_TAMERS, {cache:'no-store'}), fetch(JSON_REF, {cache:'no-store'}).catch(()=>null) ]); if(!resD.ok) throw new Error('Gagal memuat data Digimon: ' + resD.status); if(!resT.ok) throw new Error('Gagal memuat data Tamers: ' + resT.status); const rawD = await resD.json(); const rawT = await resT.json(); let rawR = null; if (resR && resR.ok){ rawR = await resR.json(); } DB = rawD.map(d => ({ id:(d.id ?? '').trim(), displayName:(d.displayName ?? '').trim(), aliases:(d.aliases ?? []).map(a=>a.trim()), stage:(d.stage ?? '').trim(), types:(d.types ?? []).map(t=>t.trim()), factions:(d.factions ?? []).map(f=>f.trim()), traits:(d.traits ?? []).map(t=>t.trim()) })); TAMERS = (rawT ?? []).map(t => ({ id:(t.id ?? '').trim(), name:(t.name ?? '').trim(), aliases:(t.aliases ?? []).map(a=>a.trim()), skillName:(t.skillName ?? '').trim(), givingBuffFor:(t.givingBuffFor ?? '').trim() })); REF = rawR ? { factions:(rawR.factions ?? []).map(f=>({code:(f.code ?? '').trim(), name:(f.name ?? '').trim(), icon:(f.icon ?? '').trim(), color:(f.color ?? '').trim()})), types:(rawR.types ?? []).map(t=>({name:(t.name ?? '').trim(), icon:(t.icon ?? '').trim()})), traits:(rawR.traits ?? []).map(t=>({id:(t.id ?? '').trim(), name:(t.name ?? '').trim(), icon:(t.icon ?? '').trim(), description:(t.description ?? '').trim()})) } : null; fillFilters(); $$('.js-pick').forEach(btn => btn.addEventListener('click', (e)=>{ const slot = e.target.closest('.slot'); openPicker(Number(slot.dataset.index)); })); $$('.js-clear').forEach(btn => btn.addEventListener('click', (e)=>{ const slot = e.target.closest('.slot'); TEAM[Number(slot.dataset.index)] = null; renderTeamBoard(); renderPickResults(); })); $$('.slot .thumb').forEach(th => th.addEventListener('click', (e)=>{ const slot = e.currentTarget.closest('.slot'); openPicker(Number(slot.dataset.index)); })); $('#btnClose').addEventListener('click', closePicker); $('#pickSearch').addEventListener('input', renderPickResults); ['filterStage','filterFaction','filterType','filterTrait'].forEach(id => { $('#'+id).addEventListener('change', renderPickResults); }); $('#pickSearch').addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ const first = Array.from($('#pickResults').querySelectorAll('.name-pill')).find(a => !a.classList.contains('disabled')); if (first) { first.click(); e.preventDefault(); } } }); $('#pickResults').addEventListener('click', (e)=>{ const a = e.target.closest('.name-pill'); if(!a) return; e.preventDefault(); const id = a.dataset.pick; if (TEAM.includes(id)){ const idx = TEAM.indexOf(id); alert(`Digimon itu sudah dipilih di slot ${idx+1}. Hapus (Clear) dulu jika ingin memindahkan.`); return; } TEAM[activeIndex] = id; closePicker(); renderTeamBoard(); renderPickResults(); }); renderTeamBoard(); renderPickResults(); }catch(err){ console.error(err); document.body.insertAdjacentHTML('beforeend', `<p style="color:#ff9aa2; padding:16px; background:var(--panel-2); border-radius:12px; max-width:1200px; margin:10px auto;"> ‚ùå Error: ${err.message}<br/><small>Periksa console (F12) untuk detail error.</small> </p>`); } })();
    // Optional adjustment when keyboard opens on mobile
    (function enhanceMobileKeyboard(){ const pickSearch = document.getElementById('pickSearch'); const modal = document.querySelector('.modal'); if (!pickSearch || !modal) return; function adjust(){ modal.style.maxHeight = '82vh'; } function restore(){ modal.style.maxHeight = ''; } pickSearch.addEventListener('focus', adjust); pickSearch.addEventListener('blur', restore); })();
  
// ====== Rekomendasi Tim (Auto-pick + Force Tamer) ======
const TEAM_RECS = [
  {
    name: "Tim Burn",
    main: ["wargreymon","shinegreymon","ancientgreymon","marinangemon","hououmon"],
    subs: ["kuzuhamon","ouryumon","ophanimon"],
    tamer: "taichi_yagami"
  },
  {
    name: "Tim Virus Buster",
    main: ["jesmon","ophanimon","seraphimon","magnamon","whitecherubimon"],
    subs: ["venusmon","dynasmon"],
    tamer: "takeru_takaishi"
  },
  {
    name: "Tim Poison",
    main: ["rosemon","lillithmon","parasimon","barbamon","babamon"],
    subs: ["kuzuhamon","blackmetalgarurumon"],
    tamer: "mimi_tachikawa"
  },
  {
    name: "Tim Nightmare Soldier",
    main: ["diablomon","blackcherubimon","parasimon","venomvamdemon","raijinmon"],
    subs: ["kuzuhamon","demon","ouryumon","dynasmon","babamon","belialvamdemon","beelzemon"],
    tamer: "hikari_yagami"
  },
  {
    name: "Tim Deep Savers",
    main: ["metalseadramon","plesiomon","leviamon","marinangemon","vikemon"],
    subs: ["metalgarurumon","neptunemon"],
    tamer: "jou_kido"
  },
  {
    name: "Tim Metal Empire",
    main: ["dukemon","blitzgreymon","herculeskabuterimon","magnamon","marinangemon"],
    subs: ["raijinmon","mugendramon","kuzuhamon","babamon"],
    tamer: "koushiro_izumi"
  },
  {
    name: "Tim Counter Attack",
    main: ["zanbamon","titamon","raijinmon","venusmon","dukemon"],
    subs: ["saintgargomon","dynasmon","marinangemon","dorugoramon"],
    tamer: "koushiro_izumi"
  },
  {
    name: "Tim Nature Spirits",
    main: ["blackmetalgarurumon","leopardmon","dynasmon-x","saberleomon","babamon"],
    subs: ["metalgarurumon","dynasmon","leviamon","kuzuhamon"],
    tamer: "yamato_ishida"
  }
];

function renderTeamRecs(){
  const box = document.getElementById('recTeamList');
  if (!box) return;
  box.innerHTML = TEAM_RECS.map((rec,i)=>`<button class="chip click" data-recid="${i}" title="Klik untuk auto-isi tim">${rec.name}</button>`).join('');
}

function renderSubs(subIds){
  const holder = document.getElementById('recSubsBox');
  if (!holder) return;
  if (!subIds || !subIds.length){ holder.innerHTML = ''; return; }
  const chips = subIds.map(id => {
    const d = DB.find(x=>x.id===id);
    const label = d?.displayName || id;
    return `<a class="chip" href="./digimon.html#${encodeURIComponent(id)}" title="Buka di Digi‚ÄëDex">${label}</a>`;
  }).join(' ');
  holder.innerHTML = `
  <div style="width:100%; display:flex; flex-wrap:wrap; gap:8px; align-items:center">
    <b>Substitusi:</b> ${chips}
  </div>
`;
}

function applyTeamRec(rec){
  for (let i=0; i<5; ++i) TEAM[i] = rec.main[i] || null;
  LOCKED_TAMER = rec.tamer; // force pick tamer rekomendasi
  const note = document.getElementById('recTamerNote');
  const btn = document.getElementById('btnUnlockTamer');
  if (note) note.hidden = false;
  if (btn) btn.hidden = false;
  renderTeamBoard();
  renderPickResults();
  renderSubs(rec.subs);
}

document.getElementById('recTeamList')?.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-recid]');
  if (!btn) return;
  const rec = TEAM_RECS[Number(btn.dataset.recid)];
  if (rec) applyTeamRec(rec);
});

document.getElementById('btnUnlockTamer')?.addEventListener('click', ()=>{
  LOCKED_TAMER = null;
  const note = document.getElementById('recTamerNote');
  const btn = document.getElementById('btnUnlockTamer');
  if (note) note.hidden = true;
  if (btn) btn.hidden = true;
  renderTeamBoard(); // kembali ke rekomendasi tamer otomatis
});

// Render daftar rekomendasi saat halaman siap
renderTeamRecs();

</script>
</body>
</html>
